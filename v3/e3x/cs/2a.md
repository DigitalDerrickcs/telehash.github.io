Cipher Set 2a
=============

This profile is the algorithms used during the telehash development process in 2013.

The base algorithms in this set are:

* **SHA2 256** - generally well trusted and produces the matching cipher key sizes
* **RSA 2048** - selected as a well known and highly trusted public key algorithm and size
* **ECC P-256** - chosen to be as different from RSA as possible to reduce single vulnerabilities, and a well known curve with many implementations and the matching ECDH secret sizes
* **AES 256-GCM** - trusted common implementations available and matching key input sizes

## Keys

When generating an endpoint including CS2a, the public/private keypair is [RSA 2048](https://en.wikipedia.org/wiki/RSA_(algorithm)).

Binary public keys are encoded in [DER](https://en.wikipedia.org/wiki/Distinguished_Encoding_Rules) as X.509 SubjectPublicKeyInfo structures.  (Most cryptographic libraries support this encoding; see [RFC 5280 section 4.1](https://tools.ietf.org/html/rfc5280#section-4.1) and [RFC 3279 section 2.3.1](https://tools.ietf.org/html/rfc3279#section-2.3.1) for more details.) 

The exchange ephemeral key is generated using [ECC](https://en.wikipedia.org/wiki/Elliptic_curve_cryptography) and the [p-256](http://csrc.nist.gov/groups/ST/toolkit/documents/dss/NISTReCur.pdf) curve and the binary public key is [uncompressed](https://www.secg.org/collateral/sec1_final.pdf) (65 bytes).


## Message Packet

BODY bytes:

* `KEY` - 256 bytes, PKCS1 [OAEP](https://en.wikipedia.org/wiki/Optimal_asymmetric_encryption_padding) (v2) RSA encrpyted ciphertext of the 64 byte uncompressed ECC P-256 ephemeral public key
* `SEQ` - 4 bytes, the network-order sequence value
* `CIPHERTEXT` - [AES-256-GCM](http://en.wikipedia.org/wiki/Galois/Counter_Mode) encrypted inner packet and sender signature
* `MAC` - 16 bytes, GCM 128-bit MAC/tag digest (some GCM implementations auto-append this)

The `CIPHERTEXT` once deciphered contains:

* `INNER` - inner packet raw bytes
* `SIG` - 256 bytes, PKCS1 v1.5 RSA signature of the KEY+INNER

The KEY is created by generating a new ephemeral elliptic (ECC) public key for this exchange and using the endpoint's RSA key to encrypt it *to* the recipient's RSA public key. The ECC keypair should be generated using the P-256 ([nistp256/secp256r/X9.62 prime256v1](http://tools.ietf.org/html/rfc6239#page-4)) curve. The key should be in the uncompressed form of XY, 64 bytes (ANSI X9.63 format with the "04" identifier prefix byte removed). The RSA encryption should use PKCS1 OAEP (v2) padding. The result is always padded to 256 bytes by OAEP.

The SIG is calculated by signing the KEY and INNER (concatenated together) using the sender's RSA public key (SHA256 hash and PKCS1 v1.5 padding), resulting in a 256 byte signature.

The CIPHERTEXT is created by encrypting the INNER and SIG (concatenated together) using AES-256-GCM.  The 12 byte (96-bit) [recommended](http://www.cryptopp.com/wiki/GCM_Mode) IV is the 4 byte SEQ left padded with zeros in order to be compatible with the most implementations.  The 32 byte key input is the SHA-256 of the 64 byte ECC public key that was used for KEY. The "tag" size for GCM is 16 bytes (128 bits), and the additional/auth data used to compute it is the 256 KEY bytes, resulting in the MAC value appended to the original packet.


## Channel Setup

Line encryption/decryption secret keys are generated by using [ECDH](https://en.wikipedia.org/wiki/Elliptic_curve_Diffieâ€“Hellman) with the local line private key, and the remote line public key, and performing a SHA-256 with the ECDH derived secret (32 bytes) and sent/received line ids (16 bytes each) from the inner packets:

* line encryption key: SHA256(ecdh-secret, my-line-id, their-line-id)
* line decryption key: SHA256(ecdh-secret, their-line-id, my-line-id)

## Channel Packets

Line packet binary is defined as:

* `IV` - 16 bytes
* `CHANNEL CIPHERTEXT` - the AES-256-GCM encrypted channel packet
* `GCM TAG/MAC` - (GMAC) - 16 bytes, GCM MAC digest (some GCM libraries auto-append this with the AES-256-GCM cipher output)

The IV is 16 random bytes generated for every line packet sent and used as the input to the GCM calculation, along with the appropriate encryption/decryption keys calculated for the line.  The tag size for GCM is 16 bytes (128 bits) and no additiona/auth data is included as input to it.


