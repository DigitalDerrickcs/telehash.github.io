Cipher Set 3a
=============

Cipher Set 3a is based on Daniel J. Bernstein's [NaCl: Networking and Cryptography library](http://nacl.cr.yp.to/index.html).  The cipher set leverages the public-key and secret-key portions of NaCl.  Implementations will need to support the crypto_box, crypto_secretbox, and crypto_onetimeauth related functions.

The version of NaCl used for 3a is implemented with `crypto_box_curve25519xsalsa20poly1305`, future versions of NaCl with other configurations will likely be defined in different Cipher Sets.

## Keys

All CS3a key pairs are generated using NaCl's [crypto_box](http://nacl.cr.yp.to/box.html) from the components for public-key cryptography.

Here is some example code:
```js
var sodium = require("sodium").api;
var keys = sodium.crypto_box_keypair();
console.log(keys.publicKey); // binary public key, 32 bytes
```

## Message BODY

The BODY of a message packet is binary and defined as the following byte sections in sequential order:

* `KEY` - 32 bytes, the sending exchange's ephemeral public key
* `NONCE` - 24 bytes, randomly generated
* `CIPHERTEXT` - the inner packet bytes encrypted using secretbox() using the `NONCE` as the nonce and the shared secret (derived from the recipients endpoint key and the included ephemeral key) as the key
* `AUTH` - 16 bytes, the calculated onetimeauth(`KEY` + `NONCE` + `CIPHERTEXT`, SHA256(`NONCE` + secret)) using the shared secret derived from both endpoint keys, the hashing is to minimize the chance that the same key input is ever used twice

## Channel Setup

Channel secret keys are generated by performing a SHA-256 hash of the shared secret (agreedKey) and the `TOKEN` values:

* channel encryption key: SHA256(secret, sent-KEY, received-KEY) / 2
* channel decryption key: SHA256(secret, received-KEY, sent-KEY) / 2

## Channel BODY

The enclosing channel packet binary is defined as the following byte sections in sequential order:

* `TOKEN` - 16 bytes, from the handshake, required for all channel packets
* `NONCE` - 24 bytes, randomly generated
* `CIPHERTEXT` - the secretbox() output representing the encrypted inner packet


See the [implementers guide](https://github.com/telehash/telehash.org/blob/master/v3/guides/implementers.md#cs3a) for some example code.


